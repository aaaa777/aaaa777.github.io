---
layout: post
title: "ファミコンのCPU命令セットメモ"
description: desc
hero_image: /img/screenshot-2023-11-20 215143.png
image: /img/screenshot-2023-11-20 215143.png
hero_height: is-large
hero_darken: true
tags:
 - blog
 - dialy
---

Factrioでファミコン（NES）のエミュレータを作るためのメモ

## CPUの動き方

ファミコンは6502という8bitCPUを使っている。

### レジスタ
アドレッシングモードによってレジスタが参照される。

|略|bit数|名前|説明|
|:---:|:---:|:---:|:---:|
|A|8|アキュムレータ|演算結果を格納する|
|X|8|インデックスレジスタ|メモリアクセスの際のアドレス計算に使う|
|Y|8|インデックスレジスタ|メモリアクセスの際のアドレス計算に使う|
|S|8|スタックポインタ|スタックの先頭アドレスを指す|
|P|8|プログラムステータス|フラグを格納する|
|PC|16|プログラムカウンタ|次に実行する命令のアドレスを格納する|

### フラグ

命令実行後の桁上がりや正負、実行時のモードが指定される。
BCDとは二進化十進表現で、4bitで0~9を表現する。

|略|名前|説明|
|:---:|:---:|:---:|
|N|ネガティブ|演算結果が負の値の場合に1になる|
|V|オーバーフロー|演算結果がオーバーフローした場合に1になる|
|B|ブレーク|BRK命令によって割り込みが発生した場合に1になる|
|D|デシマル|BCD演算を行う場合に1になる(NESでは未実装)|
|I|割り込み禁止|割り込みを無効にする場合に1になる|
|Z|ゼロ|演算結果が0の場合に1になる|
|C|キャリー|演算結果がオーバーフローした場合に1になる|

### メモリ

6502は`\$0000~\$FFFF`の16bitアドレス空間を持っており、64KByteのメモリが使用可能。
しかしレジスタが8bitしかないため、上位8bitと下位8bitの256Byteごとに扱う。
下位の256Byteはページと呼ばれ、ひとまとまりで扱われる。

ページはスタック構造になっており、スタックポインタが下位8bitを指す。
また、上位8bitが$00のページは0ページと言って特別な扱いを受ける。
専用のアドレッシングが存在し、$0000~$00FFの256Byteのメモリを少ないクロックで参照できる。

### アドレッシングモード(アドレス指定)

とりあえずここまで
アドレッシングモードまで理解したのでここまで記事を書きたすつもり。

アドレッシングモードは13種類ある。
おそらくだがオペコードの特定ビットが立っているかどうかで判別できそうだ。

|7|6|5|4|3|2|1|0|アドレッシングモード|説明|
|

## 参考

- [6502の命令セット](http://www.6502.org/tutorials/6502opcodes.html)
- [6502ニーモニック](https://img.atwiki.jp/cc65/pub/dsoft/6502.html)
- [NES研究室 - 6502](http://hp.vector.co.jp/authors/VA042397/nes/6502.html)
- [ファミコンと6502CPUに触れる｜yaito](https://note.com/yaito_geek/n/n9c9ec1c8c47f)